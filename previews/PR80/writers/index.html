<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Saving output · ClimaDiagnostics.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="ClimaDiagnostics.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaDiagnostics.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../user_guide/">User guide</a></li><li class="is-active"><a class="tocitem" href>Saving output</a><ul class="internal"><li><a class="tocitem" href="#NetCDFWriter"><span><code>NetCDFWriter</code></span></a></li><li><a class="tocitem" href="#DictWriter"><span><code>DictWriter</code></span></a></li><li><a class="tocitem" href="#HDF5Writer"><span><code>HDF5Writer</code></span></a></li></ul></li><li><a class="tocitem" href="../developer_guide/">How to add ClimaDiagnostics to a package</a></li><li><a class="tocitem" href="../internals/">Internals</a></li><li><a class="tocitem" href="../api/">APIs</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Saving output</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Saving output</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/main/docs/src/writers.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Saving-the-diagnostics"><a class="docs-heading-anchor" href="#Saving-the-diagnostics">Saving the diagnostics</a><a id="Saving-the-diagnostics-1"></a><a class="docs-heading-anchor-permalink" href="#Saving-the-diagnostics" title="Permalink"></a></h1><p>Writers are needed to save the computed diagnostics.</p><p><code>ClimaDiagnostics</code> comes with three writers:</p><ul><li><code>NetCDFWriter</code>, to interpolate and save to NetCDF files;</li><li><code>DictWriter</code>, to save <code>Field</code>s to dictionaries in memory;</li><li><code>HDF5Writer</code>, to save <code>Field</code>s to HDF5 files.</li></ul><p>(There is an additional <code>DummyWriter</code> that does nothing. It is mostly used internally for testing and debugging.)</p><p>Users are welcome to implement their own writers. A writer has to be a subtype of <code>AbstractWriter</code>and has to implement the <code>interpolate_field!</code> and <code>write_field!</code> methods. <code>interpolate_field!</code> can return <code>nothing</code> is no interpolation is needed.</p><h2 id="NetCDFWriter"><a class="docs-heading-anchor" href="#NetCDFWriter"><code>NetCDFWriter</code></a><a id="NetCDFWriter-1"></a><a class="docs-heading-anchor-permalink" href="#NetCDFWriter" title="Permalink"></a></h2><p>The <code>NetCDFWriter</code> resamples the input <code>Field</code> to a rectangular grid and saves the output to a NetCDF file. </p><p>The <code>NetCDFWriter</code> relies on the <code>Remappers</code> module in <code>ClimaCore</code> to interpolate onto the rectangular grid. Horizontally, this interpolation is a Lagrange interpolation, vertically, it is a linear. This interpolation is not conservative. Also note that, the order of vertical interpolation drops to zero in the first and last vertical elements of each column.</p><p>To create a <code>NetCDFWriter</code>, you need to specify the source <code>ClimaCore</code> <code>Space</code> and the output directory where the files should be saved. By default, the <code>NetCDFWriter</code> appends to existing files and create new ones if they do not exist. The <code>NetCDFWriter</code> does not overwrite existing data and will error out if existing data is inconsistent with the new one.</p><p><code>NetCDFWriter</code>s take as one of the inputs the desired number of points along each of the dimensions. For the horizontal dimensions, points are sampled linearly. For the vertical dimension, the behavior can be customized by passing the <code>z_sampling_method</code> variable. When <code>z_sampling_method = ClimaDiagnostics.Writers.LevelMethod()</code>, points evaluated on the grid levels (and the provided number of points ignored), when <code>z_sampling_method = ClimaDiagnostics.Writers.FakePressureLevelMethod()</code>, points are sampled uniformly in simplified hydrostatic atmospheric model.</p><p>The output in the <code>NetCDFWriter</code> roughly follows the CF conventions.</p><p>Each <code>ScheduledDiagnostic</code> is output to a different file with name determined by calling the <code>output_short_name</code> on the <code>ScheduledDiagnostic</code>. Typically, these files have names like <code>ta_1d_max.nc</code>, <code>ha_20s_inst.nc</code>, et cetera. The files define their dimensions (<code>lon</code>, <code>lat</code>, <code>z</code>, ...). Time is always the first dimension is any dataset.</p><p>Do not forget to close your writers to avoid file corruption!</p><p>To help reducing data loss, <code>NetCDFWriter</code> can force <strong>syncing</strong>, i.e. flushing the values to disk. Usually, NetCDF buffers writes to disk (because they are expensive), meaning values are not immediately written but are saved to disk in batch. This can result in data loss, and it is often useful to force NetCDF to write to disk (this is especially the case when working with GPUs). To do so, you can pass the <code>sync_schedule</code> function to the constructor of <code>NetCDFWriter</code>. When not <code>nothing</code>, <code>sync_schedule</code> is a callable that takes one argument (the <code>integrator</code>) and returns a bool. When the bool is true, the files that were modified since the last <code>sync</code> will be <code>sync</code>ed. For example, to force sync every 1000 steps, you can pass the <code>ClimaDiagnostics.Schedules.DivisorSchedule(1000)</code> schedule. By default, on GPUs, we call <code>sync</code> at the end of every time step for those files that need to be synced.</p><p>Variables are saved as datasets with attributes, where the attributes include <code>long_name</code>, <code>standard_name</code>, <code>units</code>...</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The <code>NetCDFWriter</code> cannot save raw <code>ClimaCore.Fields</code>, only fields that are resampled onto a Cartesian grids are supported. If you need such capability, consider using the <a href="../api/#ClimaDiagnostics.Writers.HDF5Writer"><code>ClimaDiagnostics.Writers.HDF5Writer</code></a>.</p></div></div><article class="docstring"><header><a class="docstring-binding" id="ClimaDiagnostics.Writers.NetCDFWriter-Tuple{Any, Any}" href="#ClimaDiagnostics.Writers.NetCDFWriter-Tuple{Any, Any}"><code>ClimaDiagnostics.Writers.NetCDFWriter</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">NetCDFWriter(space, output_dir)</code></pre><p>Save a <code>ScheduledDiagnostic</code> to a NetCDF file inside the <code>output_dir</code> of the simulation by performing a pointwise (non-conservative) remapping first.</p><p><strong>Keyword arguments</strong></p><ul><li><code>space</code>: <code>Space</code> where the <code>Fields</code> are defined. This is the most general space across the          <code>Fields</code>. In general, this is a 3D space. From a 3D space, you can take slices and           write 2D Fields, but the opposite is not true.</li><li><code>output_dir</code>: The base folder where the files should be saved.</li><li><code>num_points</code>: How many points to use along the different dimensions to interpolate the               fields. This is a tuple of integers, typically having meaning Long-Lat-Z,               or X-Y-Z (the details depend on the configuration being simulated).</li><li><code>z_sampling_method</code>: Instance of a <code>AbstractZSamplingMethod</code> that determines how points                      on the vertical direction should be chosen. By default, the vertical                      points are sampled on the grid levels.</li><li><code>compression_level</code>: How much to compress the output NetCDF file (0 is no compression, 9                      is maximum compression).</li><li><code>sync_schedule</code>: Schedule that determines when to call <code>NetCDF.sync</code> (to flush the output                  to disk). When <code>NetCDF.sync</code> is called, you can guarantee that the bits                  are written to disk (instead of being buffered in memory). A schedule is                  a boolean callable that takes as a single argument the <code>integrator</code>.                  <code>sync_schedule</code> can also be set as <code>nothing</code>, in which case we let                  handling buffered writes to disk.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/e18a1d1f6fadb638d1a40218ed4cc27b8aa267d3/src/netcdf_writer.jl#L79-L106">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaDiagnostics.Writers.interpolate_field!-Tuple{ClimaDiagnostics.Writers.NetCDFWriter, Vararg{Any, 5}}" href="#ClimaDiagnostics.Writers.interpolate_field!-Tuple{ClimaDiagnostics.Writers.NetCDFWriter, Vararg{Any, 5}}"><code>ClimaDiagnostics.Writers.interpolate_field!</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">interpolate_field!(writer::NetCDFWriter, field, diagnostic, u, p, t)</code></pre><p>Perform interpolation of <code>field</code> and save output in preallocated areas of <code>writer</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/e18a1d1f6fadb638d1a40218ed4cc27b8aa267d3/src/netcdf_writer.jl#L190-L194">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaDiagnostics.Writers.write_field!-Tuple{ClimaDiagnostics.Writers.NetCDFWriter, Vararg{Any, 5}}" href="#ClimaDiagnostics.Writers.write_field!-Tuple{ClimaDiagnostics.Writers.NetCDFWriter, Vararg{Any, 5}}"><code>ClimaDiagnostics.Writers.write_field!</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">write_field!(writer::NetCDFWriter, field::Fields.Field, diagnostic, u, p, t)</code></pre><p>Save the resampled <code>field</code> produced by <code>diagnostic</code> as directed by the <code>writer</code>.</p><p>Only the root process does something here.</p><p>Note: It assumes that the field is already resampled.</p><p>The target file is determined by <code>output_short_name(diagnostic)</code>. If the target file already exists, append to it. If not, create a new file. If the file does not contain dimensions, they are added the first time something is written.</p><p>Attributes are appended to the dataset:</p><ul><li><code>short_name</code></li><li><code>long_name</code></li><li><code>units</code></li><li><code>comments</code></li><li><code>start_date</code></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/e18a1d1f6fadb638d1a40218ed4cc27b8aa267d3/src/netcdf_writer.jl#L278-L297">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaDiagnostics.Writers.sync-Tuple{ClimaDiagnostics.Writers.NetCDFWriter}" href="#ClimaDiagnostics.Writers.sync-Tuple{ClimaDiagnostics.Writers.NetCDFWriter}"><code>ClimaDiagnostics.Writers.sync</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">sync(writer::NetCDFWriter)</code></pre><p>Call <code>NCDatasets.sync</code> on all the files in the <code>writer.unsynced_datasets</code> list. <code>NCDatasets.sync</code> ensures that the values are written to file.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/e18a1d1f6fadb638d1a40218ed4cc27b8aa267d3/src/netcdf_writer.jl#L404-L409">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="Base.close-Tuple{ClimaDiagnostics.Writers.NetCDFWriter}" href="#Base.close-Tuple{ClimaDiagnostics.Writers.NetCDFWriter}"><code>Base.close</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">close(writer::NetCDFWriter)</code></pre><p>Close all the open files in <code>writer</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/e18a1d1f6fadb638d1a40218ed4cc27b8aa267d3/src/netcdf_writer.jl#L69-L73">source</a></section></article><p>Sampling methods for the vertical direction:</p><article class="docstring"><header><a class="docstring-binding" id="ClimaDiagnostics.Writers.AbstractZSamplingMethod" href="#ClimaDiagnostics.Writers.AbstractZSamplingMethod"><code>ClimaDiagnostics.Writers.AbstractZSamplingMethod</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractZSamplingMethod</code></pre><p>The <code>AbstractZInterpolationMethod</code> defines how points along the vertical axis should be sampled.</p><p>In other words, if a column is defined between 0 and 100 and the target number of points is 50, how should those 50 points be chosen?</p><p>Available methods are:</p><ul><li><code>LevelMethod</code>: just use the grid levels</li><li><code>FakePressureLevelsMethod</code>: linearly spaced in (very) approximate atmospheric pressure levels</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/e18a1d1f6fadb638d1a40218ed4cc27b8aa267d3/src/netcdf_writer_coordinates.jl#L1-L13">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaDiagnostics.Writers.LevelsMethod" href="#ClimaDiagnostics.Writers.LevelsMethod"><code>ClimaDiagnostics.Writers.LevelsMethod</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">LevelsMethod</code></pre><p>Do not perform interpolation on <code>z</code>, use directly the grid levels instead.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/e18a1d1f6fadb638d1a40218ed4cc27b8aa267d3/src/netcdf_writer_coordinates.jl#L16-L20">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaDiagnostics.Writers.FakePressureLevelsMethod" href="#ClimaDiagnostics.Writers.FakePressureLevelsMethod"><code>ClimaDiagnostics.Writers.FakePressureLevelsMethod</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">FakePressureLevelsMethod</code></pre><p>Linearly sample points from <code>z_min</code> to <code>z_max</code> in pressure levels assuming a very simplified hydrostatic balance model.</p><p>Pressure is approximated with</p><p>p ~ p₀ exp(-z/H)</p><p>H is assumed to be 7000 m, which is a good scale height for the Earth atmosphere.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/e18a1d1f6fadb638d1a40218ed4cc27b8aa267d3/src/netcdf_writer_coordinates.jl#L23-L33">source</a></section></article><h2 id="DictWriter"><a class="docs-heading-anchor" href="#DictWriter"><code>DictWriter</code></a><a id="DictWriter-1"></a><a class="docs-heading-anchor-permalink" href="#DictWriter" title="Permalink"></a></h2><p>The <code>DictWriter</code> is a in-memory writer that is particularly useful for interactive work and debugging.</p><article class="docstring"><header><a class="docstring-binding" id="ClimaDiagnostics.Writers.DictWriter-Tuple{}" href="#ClimaDiagnostics.Writers.DictWriter-Tuple{}"><code>ClimaDiagnostics.Writers.DictWriter</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">DictWriter()</code></pre><p>A simple in-memory writer. Useful for interactive work and debugging.</p><p>You can retrieve values using the typical dictionary interface and using as keys the names of the stored diagnostics.</p><p><strong>Example</strong></p><p>Assuming we have a diagnostic with short output name &quot;mydiag&quot; stored in <code>dictW</code>. <code>dictW[&quot;mydiag&quot;]</code> will be a dictionary with keys the timesteps when the data was saved. The values are the diagnostic output (typically a <code>ClimaCore</code> <code>Field</code>).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/e18a1d1f6fadb638d1a40218ed4cc27b8aa267d3/src/dict_writer.jl#L13-L27">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaDiagnostics.Writers.write_field!-Tuple{ClimaDiagnostics.Writers.DictWriter, Vararg{Any, 5}}" href="#ClimaDiagnostics.Writers.write_field!-Tuple{ClimaDiagnostics.Writers.DictWriter, Vararg{Any, 5}}"><code>ClimaDiagnostics.Writers.write_field!</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">write_field!(writer::DictWriter, field, diagnostic, u, p, t)</code></pre><p>Add an entry to the <code>writer</code> at time <code>t</code> for the current <code>diagnostic</code> with value <code>field</code>.</p><p><code>DictWriter</code> is backed by a dictionary. Most typically, the keys of this dictionary are either strings, the <code>output_short_name</code> of the diagnostic. If the <code>output_short_name</code> is not available, use the diagnostic itself. The values of this dictionary is another dictionary that maps the time <code>t</code> to the <code>field</code> at that value.</p><p><code>DictWriter</code> implements a basic read-only dictionary interface to access the times and values.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/e18a1d1f6fadb638d1a40218ed4cc27b8aa267d3/src/dict_writer.jl#L32-L46">source</a></section></article><h2 id="HDF5Writer"><a class="docs-heading-anchor" href="#HDF5Writer"><code>HDF5Writer</code></a><a id="HDF5Writer-1"></a><a class="docs-heading-anchor-permalink" href="#HDF5Writer" title="Permalink"></a></h2><p>The <code>HDF5Writer</code> writes the <code>Field</code> directly to an HDF5 file in such a way that it can be later read and imported using the <code>InputOutput</code> module in <code>ClimaCore</code>.</p><p>The <code>HDF5Writer</code> writes one file per variable per timestep. The name of the file is determined by the <code>output_short_name</code> field of the <code>ScheduledDiagnostic</code> that is being output.</p><blockquote><p>Note: The <code>HDF5Writer</code> in <code>ClimaDiagnostics</code> is currently the least developed one. If you need this writer, we can expand it.</p></blockquote><pre><code class="language- hljs">ClimaDiagnostics.Writers.HDF5Writer
ClimaDiagnostics.Writers.write_field!(writer::ClimaDiagnostics.Writers.HDF5Writer, field, diagnostic, u, p, t)
Base.close(writer::ClimaDiagnostics.Writers.HDF5Writer)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../user_guide/">« User guide</a><a class="docs-footer-nextpage" href="../developer_guide/">How to add ClimaDiagnostics to a package »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Saturday 21 September 2024 00:18">Saturday 21 September 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
