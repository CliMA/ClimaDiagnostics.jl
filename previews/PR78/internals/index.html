<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Internals · ClimaDiagnostics.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="ClimaDiagnostics.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaDiagnostics.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../user_guide/">User guide</a></li><li><a class="tocitem" href="../writers/">Saving output</a></li><li><a class="tocitem" href="../developer_guide/">How to add ClimaDiagnostics to a package</a></li><li class="is-active"><a class="tocitem" href>Internals</a><ul class="internal"><li><a class="tocitem" href="#Schedules"><span>Schedules</span></a></li><li><a class="tocitem" href="#Accumulation"><span>Accumulation</span></a></li><li><a class="tocitem" href="#Orchestrate-diagnostics"><span>Orchestrate diagnostics</span></a></li></ul></li><li><a class="tocitem" href="../api/">APIs</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Internals</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Internals</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimaDiagnostics.jl/blob/main/docs/src/internals.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="internals_header"><a class="docs-heading-anchor" href="#internals_header">Some notes about the internals of <code>ClimaDiagnostics</code></a><a id="internals_header-1"></a><a class="docs-heading-anchor-permalink" href="#internals_header" title="Permalink"></a></h1><p>There are multiple moving parts to this package. In this page, we provide some notes about the internal design. This page also aims at <em>clarifying the whys</em>, i.e., explaining why things are the way they are. Learning about that might help you extend this package further.</p><h2 id="Schedules"><a class="docs-heading-anchor" href="#Schedules">Schedules</a><a id="Schedules-1"></a><a class="docs-heading-anchor-permalink" href="#Schedules" title="Permalink"></a></h2><p>Diagnostics are computed with a callback that is called at the end of each step. The centerpiece of is the <code>orchestrate_diagnostics</code> function, a master callback that is unconditionally executed at the end of <em>each</em> step. <code>orchestrate_diagnostics</code> loops over each registered diagnostic, computing and output those for which their trigger condition is met. Conditions are specified with schedule functions, function that take the <code>integrator</code> as single argument and return a boolean value that determines whether the callback should be executed or note. Most often, <code>schedules_func</code> are not simple functions, but callable objects (subtypes of <code>AbstractSchedule</code>). There are two reasons for this:</p><ol><li>Most realistic schedules need to hold additional data (e.g., the last time the function was called)</li><li>We want to attach names to use in the output</li></ol><p>Most of the details regarding schedules are described in the <a href="../user_guide/#user_guide_header">user guide</a>. An internal detail that is not there is related to names. We define a method for <code>show</code> for <code>AbstractSchedules</code>. This method calls the <code>short_name</code> function.</p><pre><code class="language-julia hljs">Base.show(io::IO, schedule::AbstractSchedule) =  print(io, short_name(schedule))</code></pre><p>This allows us to set names of <code>ScheduledDiagnostics</code> with <code>&quot;$schedule_func&quot;</code> in both the case <code>schedule_func</code> is a normal function, or an <code>AbstractSchedule</code>.</p><h2 id="Accumulation"><a class="docs-heading-anchor" href="#Accumulation">Accumulation</a><a id="Accumulation-1"></a><a class="docs-heading-anchor-permalink" href="#Accumulation" title="Permalink"></a></h2><p>Several diagnostics require performing reductions, such as taking the maximum or the average. Since it is not feasible to store all the lists of all the intermediate values, we aggregate the results in specific storage areas (e.g., we take <code>max(max(max(max(t1, t2), t3), t4), t5)</code> instead of <code>max(t1, t2, t3, t4, t5)</code> In this, it is convenient to preallocate the space where we want to accumulate the intermediate.</p><p>Accumulation is accomplished by the <code>accumulate!</code> function. All this function does is applying the binary <code>reduction_time_func</code> to the previous accumulated value and the newly computed one and store the output to the accumulator.</p><p>After an accumulated variable is output, the accumulator is reset to its natural state. This is achieved with the <code>reset_accumulator!</code> function. However, we have to fill the space with something that does not affect the reduction. This, by definition, is the identity of the operation. The identity of the operation <code>+</code> is <code>0</code> because <code>x + 0 = x</code> for every <code>x</code>.</p><p>We have to know the identity for every operation we want to support. Of course, users are welcome to define their own by adding new methods to identity<em>of</em>reduction.</p><p>For instance, to define the identity of the reduction <code>-</code>, one would write</p><pre><code class="language-julia hljs">function ClimaDiagnostics.Diagnostics.identity_of_reduction(::typeof(-))
    return 0
end</code></pre><p>(Or add this to the <code>reduction_identities.jl</code> file.)</p><h3 id="On-the-design-of-the-DiagnosticsHandler"><a class="docs-heading-anchor" href="#On-the-design-of-the-DiagnosticsHandler">On the design of the <code>DiagnosticsHandler</code></a><a id="On-the-design-of-the-DiagnosticsHandler-1"></a><a class="docs-heading-anchor-permalink" href="#On-the-design-of-the-DiagnosticsHandler" title="Permalink"></a></h3><p>There are two possible choices for accumulation of variables: each scheduled diagnostic can carry its accumulator and counters, or all the accumulators and counters are managed by a single central handler. <code>ClimaDiagnostics</code> implements this second approach. The author of this package has not decided whether this is a good idea or not. On one side, this allows us to have a concretely typed and well defined <code>DiagnosticsHandler</code> struct. On the other side, it forces us to initialize all the diagnostics at the very beginning of the simulation (this can also be a positive side, because it allows us to compile all the diagnostics at once). It might be worth exploring the alternative design where the <code>ScheduledDiagnostics</code> get their storage space the first time they are called.</p><p>Given this restriction, the main entry point for <code>ClimaDiagnostics</code> is the <code>IntegratorWithDiagnostics</code> function. This function is a little dissatisfying because it creates a new integrator obtained by copying all the fields of the old one and adding the diagnostics (with <a href="https://github.com/JuliaObjects/Accessors.jl"><code>Accessors</code></a>).</p><h2 id="Orchestrate-diagnostics"><a class="docs-heading-anchor" href="#Orchestrate-diagnostics">Orchestrate diagnostics</a><a id="Orchestrate-diagnostics-1"></a><a class="docs-heading-anchor-permalink" href="#Orchestrate-diagnostics" title="Permalink"></a></h2><p>One of the design goals for <code>orchestrate_diagnostics</code> is to keep all the broadcasted expression in the same function scope. This opens a path to optimize the number of GPU kernel launches. </p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../developer_guide/">« How to add ClimaDiagnostics to a package</a><a class="docs-footer-nextpage" href="../api/">APIs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Wednesday 18 September 2024 21:01">Wednesday 18 September 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
